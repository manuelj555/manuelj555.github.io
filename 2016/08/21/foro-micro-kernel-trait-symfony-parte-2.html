<!DOCTYPE html>
<html>
<head>   
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />

    <title>PHP + Symfony Tips - Creando un Foro con el MicroKernelTrait de Symfony (Parte 2)</title>
    <meta name="description" content="" />

    <meta name="HandheldFriendly" content="True" />
    <meta name="MobileOptimized" content="320" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="stylesheet" type="text/css" href="/assets/css/normalize.css" />
    <link rel="stylesheet" type="text/css" href="/assets/css/screen.css" />
    <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Noto+Serif:400,700,400italic|Open+Sans:700,400" />
    <!-- This is for syntax highlight -->
    <link rel="stylesheet" type="text/css" href="/assets/css/syntax.css">
    <!-- Customisation  -->
    <link rel="stylesheet" type="text/css" href="/assets/css/main.css" />

</head>
<body class="home-template">

    <main class="content" role="main">

    <article class="post">
        <header class="post-header">
            <a id="blog-logo" href="http://manuelj555.github.io/">
                
                <span class="blog-title">PHP + Symfony Tips</span>
                 
            </a>
        </header>

        <span class="post-meta">
            <time datetime="2016-08-21">21 Aug 2016</time>
            
            on
            
            
       	</span>

        <h1 class="post-title">Creando un Foro con el MicroKernelTrait de Symfony (Parte 2)</h1>

        <section class="post-content">
            <p>Esta es la segunda parte de una serie de artículos donde se explicará paso a paso el desarrollo de una aplicación muy simple utilizando el <a href="http://symfony.com/doc/current/configuration/micro_kernel_trait.html">MicroKernelTrait de Symfony</a>.</p>

<p><a href="/2016/08/14/foro-micro-kernel-trait-symfony-parte-1.html">Parte 1</a></p>

<p><em><strong>Nota</strong>: Los posts se enfocarán a usuarios que tengan conocimientos previos de Symfony, que conozcan sobre el AppKernel, los directorios básicos de un proyecto symfony y de los archivos de configuración y rutas.</em></p>

<hr />

<h1 id="manejando-las-preguntas">Manejando las Preguntas</h1>

<p>En esta parte se va a trabajar con la administración de las preguntas, lo cual implica:</p>

<ul>
  <li>Creación de la Base de Datos.</li>
  <li>Creación de Preguntas.</li>
  <li>Visualización de Preguntas (Listado).</li>
</ul>

<p>La estructura de archivos que se va a crear/editar en esta parte es la siguiente:</p>

<div class="highlighter-rouge"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12</pre></td><td class="code"><pre>app/config/config.yml                                              // Edición
app/config/parameters.yml                                          // Creación
app/config/services.yml                                            // Creación
app/Resources/views/base.html.twig                                 // Creación
app/Resources/views/question/list.html.twig                        // Creación
app/Resources/views/question/new.html.twig                         // Creación
src/App/Controller/QuestionController.php                          // Creación
src/App/Form/QuestionType.php                                      // Edición
src/Forum/Question/Question.php                                    // Creación
src/Forum/Question/Factory/QuestionFactory.php                     // Creación
src/Forum/Question/Repository/QuestionRepository.php               // Creación
src/Forum/Question/Repository/DbQuestionRepository.php             // Creación
</pre></td></tr></tbody></table>
</div>

<hr />

<h3 id="la-base-de-datos">La Base de Datos</h3>

<p>Lo primero que haremos será crear una base de datos para conectarnos a ella. Para efectos del ejemplo se decidió trabajar con una base de datos Mysql. Llamaremos a la base de datos <strong>micro-foro</strong> y crearemos la siguiente tabla:</p>

<div class="language-sql highlighter-rouge"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9</pre></td><td class="code"><pre><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="nv">`questions`</span> <span class="p">(</span>
    <span class="nv">`id`</span> <span class="n">INT</span> <span class="p">(</span><span class="mi">11</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="n">AUTO_INCREMENT</span><span class="p">,</span>
    <span class="nv">`title`</span> <span class="n">VARCHAR</span> <span class="p">(</span><span class="mi">255</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="nv">`description`</span> <span class="n">text</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="nv">`author`</span> <span class="n">VARCHAR</span> <span class="p">(</span><span class="mi">255</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="nv">`created`</span> <span class="n">datetime</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="nv">`resolved`</span> <span class="n">bit</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
     <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="nv">`id`</span><span class="p">)</span>
<span class="p">)</span> <span class="n">ENGINE</span> <span class="o">=</span> <span class="n">INNODB</span>
</pre></td></tr></tbody></table>
</div>

<p>Se crea la tabla con esa estructura ya que debemos recordar que los atributos de las preguntas son:</p>

<ul>
  <li>id</li>
  <li>title</li>
  <li>description</li>
  <li>author</li>
  <li>createdAt</li>
  <li>resolved</li>
</ul>

<p>Con la tabla creada procedemos a trabajar en los archivos y clases necesarios para administrar preguntas en la aplicación.</p>

<hr />

<h3 id="la-clase-question">La clase <em>Question</em></h3>

<p>La idea es modelar la tabla en un objeto php para tener una representación de las preguntas en la aplicación. Para lo cual se crea la clase (Entidad o Modelo) que representa una pregunta.</p>

<div class="language-php highlighter-rouge"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62</pre></td><td class="code"><pre><span class="cp">&lt;?php</span> <span class="c1">// src/Forum/Question/Question.php
</span>
<span class="k">namespace</span> <span class="nx">Forum\Question</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Symfony\Component\Validator\Constraints</span> <span class="k">as</span> <span class="nx">Assert</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">Question</span>
<span class="p">{</span>
    <span class="sd">/** @var int */</span>
    <span class="k">private</span> <span class="nv">$id</span><span class="p">;</span>

    <span class="sd">/**
     * @var string
     *
     * @Assert\NotBlank(message="Por favor, indique el título de su pregunta")
     */</span>
    <span class="k">private</span> <span class="nv">$title</span><span class="p">;</span>

    <span class="sd">/**
     * @var string
     *
     * @Assert\NotBlank(message="Por favor, describa su pregunta")
     */</span>
    <span class="k">private</span> <span class="nv">$description</span><span class="p">;</span>

    <span class="sd">/** @var string */</span>
    <span class="k">private</span> <span class="nv">$author</span><span class="p">;</span>

    <span class="sd">/** @var \DateTime */</span>
    <span class="k">private</span> <span class="nv">$createdAt</span><span class="p">;</span>

    <span class="sd">/** @var bool */</span>
    <span class="k">private</span> <span class="nv">$resolved</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">__construct</span><span class="p">(</span><span class="nv">$title</span><span class="p">,</span> <span class="nv">$description</span><span class="p">,</span> <span class="nv">$author</span><span class="p">,</span> <span class="nx">\DateTime</span> <span class="nv">$createdAt</span> <span class="o">=</span> <span class="kc">null</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">title</span> <span class="o">=</span> <span class="nv">$title</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">description</span> <span class="o">=</span> <span class="nv">$description</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">author</span> <span class="o">=</span> <span class="nv">$author</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">createdAt</span> <span class="o">=</span> <span class="nv">$createdAt</span> <span class="o">?:</span> <span class="k">new</span> <span class="nx">\DateTime</span><span class="p">(</span><span class="s1">'now'</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">getId</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">;</span> <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">setId</span><span class="p">(</span><span class="nv">$id</span><span class="p">)</span> <span class="p">{</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">id</span> <span class="o">=</span> <span class="nv">$id</span><span class="p">;</span> <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">getTitle</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">title</span><span class="p">;</span> <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">setTitle</span><span class="p">(</span><span class="nv">$title</span><span class="p">)</span> <span class="p">{</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">title</span> <span class="o">=</span> <span class="nv">$title</span><span class="p">;</span> <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">getDescription</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">description</span><span class="p">;</span> <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">setDescription</span><span class="p">(</span><span class="nv">$description</span><span class="p">)</span> <span class="p">{</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">description</span> <span class="o">=</span> <span class="nv">$description</span><span class="p">;</span> <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">getAuthor</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">author</span><span class="p">;</span> <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">getCreatedAt</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">createdAt</span><span class="p">;</span> <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">isResolved</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">resolved</span><span class="p">;</span> <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">markAsResolved</span><span class="p">()</span> <span class="p">{</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">resolved</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table>
</div>

<p>La clase posee un atributo por cada propiedad de la pregunta, además se agregan algunas <a href="http://symfony.com/doc/current/validation.html#constraints">Registricciones de Validación</a>, aprovenchando el <a href="http://symfony.com/doc/current/validation.html">Validador de Symfony</a>.</p>

<h3 id="la-clase-questionrepository">La clase QuestionRepository</h3>

<p>Debido a que necesitamos de alguna manera obtener y persistir las preguntas en la aplicación, vamos hacer uso del <a href="http://stackoverflow.com/questions/16176990/proper-repository-pattern-design-in-php">patrón repositorio</a> el cual nos permite mapear los modelos contra una fuente de datos que puede ser una base de datos, una api rest, la sesión, etc.</p>

<p>Teniendo en cuenta que debemos poder crear, listar y actualizar preguntas en la base de datos, vamos a definir los siguientes métodos para la interfaz:</p>

<ul>
  <li><strong>save</strong>: Crea o actualiza una pregunta en la base de datos.</li>
  <li><strong>find</strong>: Obtiene una pregunta en base a su id.</li>
  <li><strong>findAll</strong>: Obtiene las preguntas ordenadas de forma descendiente.</li>
</ul>

<p>El código de la interfaz <code class="highlighter-rouge">QuestionRepository</code> es el siguiente:</p>

<div class="language-php highlighter-rouge"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30</pre></td><td class="code"><pre><span class="cp">&lt;?php</span> <span class="c1">// src/Forum/Question/Repository/QuestionRepository.php
</span>
<span class="k">namespace</span> <span class="nx">Forum\Question\Repository</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Forum\Question\Question</span><span class="p">;</span>

<span class="k">interface</span> <span class="nx">QuestionRepository</span>
<span class="p">{</span>
    <span class="sd">/**
     * Agrega o Actualiza una pregunta en el repositorio.
     *
     * @param Question $question
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">save</span><span class="p">(</span><span class="nx">Question</span> <span class="nv">$question</span><span class="p">);</span>

    <span class="sd">/**
     * Busca una pregunta por su id y la retorna.
     * Si no existe, rentorna null
     * @param $id
     * @return Question|null
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">find</span><span class="p">(</span><span class="nv">$id</span><span class="p">);</span>

    <span class="sd">/**
     * Retorna un arreglo de preguntas ordenados de forma descendiente.
     *
     * @return Question[]|array
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">findAll</span><span class="p">();</span>
<span class="p">}</span>
</pre></td></tr></tbody></table>
</div>

<h3 id="la-clase-dbquestionrepository">La clase DbQuestionRepository</h3>

<p>Para efectos de estos tutoriales las implementaciones de los repositorios utilizarán <a href="http://docs.doctrine-project.org/projects/doctrine-dbal/en/latest/">Doctrine DBAL</a> para comunicarse con la base de datos, y asi aplicar buenas prácticas de creación de código limpio.</p>

<div class="language-php highlighter-rouge"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87</pre></td><td class="code"><pre><span class="cp">&lt;?php</span> <span class="c1">// src/Forum/Question/Repository/DbQuestionRepository.php
</span>
<span class="k">namespace</span> <span class="nx">Forum\Question\Repository</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Doctrine\DBAL\Connection</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Forum\Question\Factory\QuestionFactory</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Forum\Question\Question</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">DbQuestionRepository</span> <span class="k">implements</span> <span class="nx">QuestionRepository</span>
<span class="p">{</span>
    <span class="sd">/**
     * @var Connection
     */</span>
    <span class="k">private</span> <span class="nv">$connection</span><span class="p">;</span>

    <span class="sd">/**
     * @var QuestionFactory
     */</span>
    <span class="k">private</span> <span class="nv">$factory</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">__construct</span><span class="p">(</span><span class="nx">Connection</span> <span class="nv">$connection</span><span class="p">,</span> <span class="nx">QuestionFactory</span> <span class="nv">$factory</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">connection</span> <span class="o">=</span> <span class="nv">$connection</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">factory</span> <span class="o">=</span> <span class="nv">$factory</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">save</span><span class="p">(</span><span class="nx">Question</span> <span class="nv">$question</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$question</span><span class="o">-&gt;</span><span class="na">getId</span><span class="p">())</span> <span class="p">{</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">update</span><span class="p">(</span><span class="nv">$question</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">create</span><span class="p">(</span><span class="nv">$question</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">find</span><span class="p">(</span><span class="nv">$id</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$data</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">connection</span><span class="o">-&gt;</span><span class="na">fetchAssoc</span><span class="p">(</span><span class="s1">'SELECT * FROM questions WHERE id = ?'</span><span class="p">,</span> <span class="p">[</span><span class="nv">$id</span><span class="p">]);</span>

        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">factory</span><span class="o">-&gt;</span><span class="na">createFromArray</span><span class="p">(</span><span class="nv">$data</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">findAll</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$data</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">connection</span><span class="o">-&gt;</span><span class="na">fetchAll</span><span class="p">(</span><span class="s1">'SELECT * FROM questions ORDER BY id DESC'</span><span class="p">);</span>

        <span class="nv">$questions</span> <span class="o">=</span> <span class="p">[];</span>

        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$data</span> <span class="k">as</span> <span class="nv">$item</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$questions</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">factory</span><span class="o">-&gt;</span><span class="na">createFromArray</span><span class="p">(</span><span class="nv">$item</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nv">$questions</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">function</span> <span class="nf">create</span><span class="p">(</span><span class="nx">Question</span> <span class="nv">$question</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$id</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">connection</span><span class="o">-&gt;</span><span class="na">insert</span><span class="p">(</span>
            <span class="s1">'questions'</span><span class="p">,</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">toArray</span><span class="p">(</span><span class="nv">$question</span><span class="p">),</span>
            <span class="p">[</span><span class="s1">'created'</span> <span class="o">=&gt;</span> <span class="s1">'datetime'</span><span class="p">]</span> <span class="c1">// Para que Doctrine convierte el \Datetime a string
</span>        <span class="p">);</span>

        <span class="nv">$question</span><span class="o">-&gt;</span><span class="na">setId</span><span class="p">(</span><span class="nv">$id</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">function</span> <span class="nf">update</span><span class="p">(</span><span class="nx">Question</span> <span class="nv">$question</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">connection</span><span class="o">-&gt;</span><span class="na">update</span><span class="p">(</span>
            <span class="s1">'questions'</span><span class="p">,</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">toArray</span><span class="p">(</span><span class="nv">$question</span><span class="p">),</span>
            <span class="p">[</span><span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="nv">$question</span><span class="o">-&gt;</span><span class="na">getId</span><span class="p">()],</span>
            <span class="p">[</span><span class="s1">'created'</span> <span class="o">=&gt;</span> <span class="s1">'datetime'</span><span class="p">]</span> <span class="c1">// Para que Doctrine convierte el \Datetime a string
</span>        <span class="p">);</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">function</span> <span class="nf">toArray</span><span class="p">(</span><span class="nx">Question</span> <span class="nv">$question</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="s1">'title'</span> <span class="o">=&gt;</span> <span class="nv">$question</span><span class="o">-&gt;</span><span class="na">getTitle</span><span class="p">(),</span>
            <span class="s1">'description'</span> <span class="o">=&gt;</span> <span class="nv">$question</span><span class="o">-&gt;</span><span class="na">getDescription</span><span class="p">(),</span>
            <span class="s1">'author'</span> <span class="o">=&gt;</span> <span class="nv">$question</span><span class="o">-&gt;</span><span class="na">getAuthor</span><span class="p">(),</span>
            <span class="s1">'created'</span> <span class="o">=&gt;</span> <span class="nv">$question</span><span class="o">-&gt;</span><span class="na">getCreatedAt</span><span class="p">(),</span>
            <span class="s1">'resolved'</span> <span class="o">=&gt;</span> <span class="nv">$question</span><span class="o">-&gt;</span><span class="na">isResolved</span><span class="p">(),</span>
        <span class="p">];</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table>
</div>

<p>Como se puede ver, el repositorio tiene dos dependencias, la clase <code class="highlighter-rouge">Doctrine\DBAL\Connection</code> de Doctrine y la clase <code class="highlighter-rouge">Forum\Question\Factory\QuestionFactory</code>. La primera nos permite comunicarnos con la Base de datos, y la segunda nos permite crear objetos de tipo <code class="highlighter-rouge">Forum\Question\Question</code> en base a un array.</p>

<h3 id="la-clase-questionfactory">La clase QuestionFactory</h3>

<p>Esta clase tiene como finalidad convertir un arreglo (Que es lo que obtenemos al consultar la base de datos con Doctrine DBAL) en una instancia de la clase <code class="highlighter-rouge">Forum\Question\Question</code>. Su contenido es:</p>

<div class="language-php highlighter-rouge"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29</pre></td><td class="code"><pre><span class="cp">&lt;?php</span> <span class="c1">// src/Forum/Question/Factory/QuestionFactory.php
</span>
<span class="k">namespace</span> <span class="nx">Forum\Question\Factory</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Forum\Question\Question</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">QuestionFactory</span>
<span class="p">{</span>
    <span class="sd">/**
     * Crea un objeto Question a partir de un arreglo
     *
     * @param array $data
     * @return Question
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">createFromArray</span><span class="p">(</span><span class="nv">$data</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$question</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Question</span><span class="p">(</span>
            <span class="nv">$data</span><span class="p">[</span><span class="s1">'title'</span><span class="p">],</span>
            <span class="nv">$data</span><span class="p">[</span><span class="s1">'description'</span><span class="p">],</span>
            <span class="nv">$data</span><span class="p">[</span><span class="s1">'author'</span><span class="p">],</span>
            <span class="k">new</span> <span class="nx">\DateTime</span><span class="p">(</span><span class="nv">$data</span><span class="p">[</span><span class="s1">'created'</span><span class="p">])</span>
        <span class="p">);</span>

        <span class="nv">$question</span><span class="o">-&gt;</span><span class="na">setId</span><span class="p">((</span><span class="nx">int</span><span class="p">)</span><span class="nv">$data</span><span class="p">[</span><span class="s1">'id'</span><span class="p">]);</span>
        <span class="nv">$data</span><span class="p">[</span><span class="s1">'resolved'</span><span class="p">]</span> <span class="k">and</span> <span class="nv">$question</span><span class="o">-&gt;</span><span class="na">markAsResolved</span><span class="p">();</span>

        <span class="k">return</span> <span class="nv">$question</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table>
</div>

<hr />

<h2 id="registrando-las-clases-como-servicios">Registrando las clases como servicios</h2>

<p>Gracias a que estamos usando Symfony disponemos de un contenedor de clases, por lo que vamos a registrar el repositorio y sus dependencias como un servicio.</p>

<h5 id="creando-el-appconfigparametersyml">Creando el app/config/parameters.yml</h5>

<p>Siguiendo el estandar de los proyectos en Symfony vamos a crear un archivo YAML para nuestros parametros:</p>

<div class="language-yaml highlighter-rouge"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6</pre></td><td class="code"><pre><span class="s">parameters</span><span class="pi">:</span>
    <span class="s">database_host</span><span class="pi">:</span> <span class="s2">"</span><span class="s">127.0.0.1"</span>
    <span class="s">database_driver</span><span class="pi">:</span> <span class="s2">"</span><span class="s">pdo_mysql"</span>
    <span class="s">database_name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">micro-foro"</span>
    <span class="s">database_user</span><span class="pi">:</span> <span class="s2">"</span><span class="s">root"</span>
    <span class="s">database_password</span><span class="pi">:</span> <span class="s">~</span>
</pre></td></tr></tbody></table>
</div>

<h5 id="creando-el-appconfigservicesyml">Creando el app/config/services.yml</h5>

<p>En este archivo se van a ir registrando los servicios mientras se vaya avanzando en la construcción de la aplicación:</p>

<div class="language-yaml highlighter-rouge"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24</pre></td><td class="code"><pre><span class="s">services</span><span class="pi">:</span>
    <span class="c1"># Clase necesaria para la conexión DBAL</span>
    <span class="s">database.configuration</span><span class="pi">:</span>
        <span class="s">public</span><span class="pi">:</span> <span class="s">false</span>
        <span class="s">class</span><span class="pi">:</span> <span class="s">Doctrine\DBAL\Configuration</span>

    <span class="c1"># Representa la conexión con la base de datos</span>
    <span class="s">database.connection</span><span class="pi">:</span>
        <span class="s">public</span><span class="pi">:</span> <span class="s">false</span>
        <span class="s">class</span><span class="pi">:</span> <span class="s">Doctrine\DBAL\Connection</span>
        <span class="s">factory</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">Doctrine\DBAL\DriverManager</span><span class="pi">,</span> <span class="nv">getConnection</span><span class="pi">]</span>
        <span class="s">arguments</span><span class="pi">:</span>
            <span class="pi">-</span>   <span class="s">host</span><span class="pi">:</span> <span class="s2">"</span><span class="s">%database_host%"</span>
                <span class="s">dbname</span><span class="pi">:</span> <span class="s2">"</span><span class="s">%database_name%"</span>
                <span class="s">user</span><span class="pi">:</span> <span class="s2">"</span><span class="s">%database_user%"</span>
                <span class="s">password</span><span class="pi">:</span> <span class="s2">"</span><span class="s">%database_password%"</span>
                <span class="s">driver</span><span class="pi">:</span> <span class="s2">"</span><span class="s">%database_driver%"</span>
            <span class="pi">-</span> <span class="s2">"</span><span class="s">@database.configuration"</span>

    <span class="c1"># Representa la implementación de Forum\Question\Repository\QuestionRepository</span>
    <span class="s">repository.question</span><span class="pi">:</span>
        <span class="s">class</span><span class="pi">:</span> <span class="s">Forum\Question\Repository\DbQuestionRepository</span>
        <span class="s">autowire</span><span class="pi">:</span> <span class="s">true</span> <span class="c1"># el autowire activa la inyección de dependencias automática.</span>
        <span class="c1"># los argumentos son inyectados de forma automática gracias al autowiring</span>
</pre></td></tr></tbody></table>
</div>

<p>Inicialmente tenemos estos tres servicios: <code class="highlighter-rouge">database.configuration</code>, <code class="highlighter-rouge">database.connection</code> y <code class="highlighter-rouge">repository.question</code>, los cuales nos permiten comunicarnos con la base de datos y administrar las preguntas.</p>

<p>Cabe destacar que el repositorio utiliza una funcionalidad llamada <a href="http://symfony.com/doc/current/components/dependency_injection/autowiring.html">autowire</a>, que se encarga de pasarle las dependencias al repositorio de forma automática en base a los tipos de datos esperados por nuestra clase en su constructor.</p>

<h5 id="cambios-en-el-configyml">Cambios en el config.yml</h5>

<p>Por último en la parte de configuración vamos a registrar los nuevos archivos yaml en el config.yml, además vamos a activar algunos componenets que serán necesarios para validar y crear formularios de las preguntas:</p>

<div class="language-yaml highlighter-rouge"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19</pre></td><td class="code"><pre><span class="s">imports</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="pi">{</span> <span class="nv">resource</span><span class="pi">:</span> <span class="nv">parameters.yml</span> <span class="pi">}</span>
    <span class="pi">-</span> <span class="pi">{</span> <span class="nv">resource</span><span class="pi">:</span> <span class="nv">services.yml</span> <span class="pi">}</span>

<span class="s">framework</span><span class="pi">:</span>
    <span class="s">secret</span><span class="pi">:</span> <span class="s">StringAleatorio</span>
    <span class="s">templating</span><span class="pi">:</span>
        <span class="s">engines</span><span class="pi">:</span> <span class="pi">[</span><span class="s1">'</span><span class="s">twig'</span><span class="pi">]</span>
    <span class="s">form</span><span class="pi">:</span> <span class="s">~</span>                       <span class="c1"># Nos permite crear y trabajar con formularios de Symfony.</span>
    <span class="s">validation</span><span class="pi">:</span>                   <span class="c1"># Activa la validación de objetos.</span>
        <span class="s">enable_annotations</span><span class="pi">:</span> <span class="s">true</span>
    <span class="s">translator</span><span class="pi">:</span>                   <span class="c1"># Activa la traducción de las validaciones.</span>
        <span class="s">fallback</span><span class="pi">:</span> <span class="s">es</span>
    <span class="s">default_locale</span><span class="pi">:</span> <span class="s">es</span>

<span class="c1"># Registramos un tema de formularios para mejorar el aspecto de los mismos.</span>
<span class="s">twig</span><span class="pi">:</span>
    <span class="s">form_theme</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s1">'</span><span class="s">form/fields.html.twig'</span>
</pre></td></tr></tbody></table>
</div>

<p>Se agrega un archivo de temas de formulario en la configuración de twig. El contenido de dicho archivo es el siguiente:</p>

<p><strong>app/Resources/views/form/fields.html.twig</strong></p>

<div class="language-twig highlighter-rouge"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32</pre></td><td class="code"><pre><span class="c">{# app/Resources/views/form/fields.html.twig #}</span>
<span class="cp">{%</span> <span class="k">use</span> <span class="s1">'form_div_layout.html.twig'</span> <span class="cp">%}</span>

<span class="cp">{%</span> <span class="k">block</span> <span class="nv">form_row</span> <span class="cp">%}</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"form-row</span><span class="cp">{%</span> <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="nv">compound</span> <span class="ow">or</span> <span class="nv">force_error</span><span class="o">|</span><span class="nf">default</span><span class="p">(</span><span class="kp">false</span><span class="p">))</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nv">valid</span> <span class="cp">%}</span><span class="s"> has-error</span><span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span><span class="s">"</span><span class="nt">&gt;</span>
        <span class="cp">{{</span><span class="o">-</span> <span class="nv">form_label</span><span class="p">(</span><span class="nv">form</span><span class="p">)</span> <span class="o">-</span><span class="cp">}}</span>
        <span class="cp">{{</span><span class="o">-</span> <span class="nv">form_widget</span><span class="p">(</span><span class="nv">form</span><span class="p">)</span> <span class="o">-</span><span class="cp">}}</span>
        <span class="cp">{{</span><span class="o">-</span> <span class="nv">form_errors</span><span class="p">(</span><span class="nv">form</span><span class="p">)</span> <span class="o">-</span><span class="cp">}}</span>
    <span class="nt">&lt;/div&gt;</span>
<span class="cp">{%</span> <span class="k">endblock</span> <span class="cp">%}</span>

<span class="cp">{%</span><span class="o">-</span> <span class="k">block</span> <span class="nv">form_errors</span> <span class="o">-</span><span class="cp">%}</span>
    <span class="cp">{%</span><span class="o">-</span> <span class="k">if</span> <span class="nv">errors</span><span class="o">|</span><span class="nf">length</span> <span class="o">&gt;</span> <span class="nv">0</span> <span class="o">-</span><span class="cp">%}</span>
        <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"form-errors"</span><span class="nt">&gt;</span>
            <span class="cp">{%</span><span class="o">-</span> <span class="k">for</span> <span class="nv">error</span> <span class="ow">in</span> <span class="nv">errors</span> <span class="o">-</span><span class="cp">%}</span>
                <span class="nt">&lt;li&gt;</span><span class="cp">{{</span> <span class="nv">error.message</span> <span class="cp">}}</span><span class="nt">&lt;/li&gt;</span>
            <span class="cp">{%</span><span class="o">-</span> <span class="k">endfor</span> <span class="o">-</span><span class="cp">%}</span>
        <span class="nt">&lt;/ul&gt;</span>
    <span class="cp">{%</span><span class="o">-</span> <span class="k">endif</span> <span class="o">-</span><span class="cp">%}</span>
<span class="cp">{%</span><span class="o">-</span> <span class="k">endblock</span> <span class="nv">form_errors</span> <span class="o">-</span><span class="cp">%}</span>

<span class="cp">{%</span> <span class="k">block</span> <span class="nv">form_widget_simple</span> <span class="o">-</span><span class="cp">%}</span>
    <span class="cp">{%</span> <span class="k">if</span> <span class="nv">type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">defined</span> <span class="ow">or</span> <span class="nv">type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">'file'</span><span class="p">,</span> <span class="s1">'hidden'</span><span class="p">]</span> <span class="cp">%}</span>
        <span class="cp">{%</span><span class="o">-</span> <span class="k">set</span> <span class="nv">attr</span> <span class="err">=</span> <span class="nv">attr</span><span class="o">|</span><span class="nf">merge</span><span class="p">(</span><span class="err">{</span><span class="nv">class</span><span class="err">:</span> <span class="p">(</span><span class="nv">attr.class</span><span class="o">|</span><span class="nf">default</span><span class="p">(</span><span class="s1">''</span><span class="p">)</span> <span class="err">~</span> <span class="s1">' form-widget'</span><span class="p">)</span><span class="o">|</span><span class="nf">trim</span><span class="err">}</span><span class="p">)</span> <span class="o">-</span><span class="cp">%}</span>
    <span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span>
    <span class="cp">{{</span><span class="o">-</span> <span class="nv">parent</span><span class="p">()</span> <span class="o">-</span><span class="cp">}}</span>
<span class="cp">{%</span><span class="o">-</span> <span class="k">endblock</span> <span class="nv">form_widget_simple</span> <span class="cp">%}</span>

<span class="cp">{%</span> <span class="k">block</span> <span class="nv">textarea_widget</span> <span class="o">-</span><span class="cp">%}</span>
    <span class="cp">{%</span> <span class="k">set</span> <span class="nv">attr</span> <span class="err">=</span> <span class="nv">attr</span><span class="o">|</span><span class="nf">merge</span><span class="p">(</span><span class="err">{</span><span class="nv">class</span><span class="err">:</span> <span class="p">(</span><span class="nv">attr.class</span><span class="o">|</span><span class="nf">default</span><span class="p">(</span><span class="s1">''</span><span class="p">)</span> <span class="err">~</span> <span class="s1">' form-widget'</span><span class="p">)</span><span class="o">|</span><span class="nf">trim</span><span class="err">}</span><span class="p">)</span> <span class="cp">%}</span>
    <span class="cp">{{</span><span class="o">-</span> <span class="nv">parent</span><span class="p">()</span> <span class="o">-</span><span class="cp">}}</span>
<span class="cp">{%</span><span class="o">-</span> <span class="k">endblock</span> <span class="nv">textarea_widget</span> <span class="cp">%}</span>
</pre></td></tr></tbody></table>
</div>

<hr />

<h2 id="creando-y-listando-preguntas">Creando y Listando Preguntas</h2>

<p>Con las clases del Negocio ya creadas, ahora vamos a crear las clases y archivos propias del módulo de creación y listado de preguntas. Los archivos que vamos a crear son:</p>

<div class="highlighter-rouge"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4</pre></td><td class="code"><pre>app/Resources/views/question/new.html.twig
app/Resources/views/question/list.html.twig
src/App/Controller/QuestionController.php
src/App/Form/QuestionType.php
</pre></td></tr></tbody></table>
</div>

<p>Comenzaremos por la clase de formulario:</p>

<h5 id="el-formulario-srcappformquestiontypephp">El Formulario <strong>src/App/Form/QuestionType.php</strong></h5>

<div class="language-php highlighter-rouge"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41</pre></td><td class="code"><pre><span class="cp">&lt;?php</span>  <span class="c1">// src/App/Form/QuestionType.php
</span>
<span class="k">namespace</span> <span class="nx">App\Form</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Forum\Question\Question</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\Form\AbstractType</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\Form\Extension\Core\Type\TextareaType</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\Form\Extension\Core\Type\TextType</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\Form\FormBuilderInterface</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\Form\FormInterface</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\OptionsResolver\Options</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\OptionsResolver\OptionsResolver</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">QuestionType</span> <span class="k">extends</span> <span class="nx">AbstractType</span>
<span class="p">{</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">buildForm</span><span class="p">(</span><span class="nx">FormBuilderInterface</span> <span class="nv">$builder</span><span class="p">,</span> <span class="k">array</span> <span class="nv">$options</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$builder</span><span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span><span class="s1">'title'</span><span class="p">,</span> <span class="nx">TextType</span><span class="o">::</span><span class="na">class</span><span class="p">);</span>
        <span class="nv">$builder</span><span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span><span class="s1">'description'</span><span class="p">,</span> <span class="nx">TextareaType</span><span class="o">::</span><span class="na">class</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">configureOptions</span><span class="p">(</span><span class="nx">OptionsResolver</span> <span class="nv">$resolver</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$resolver</span><span class="o">-&gt;</span><span class="na">setDefaults</span><span class="p">([</span>
            <span class="s1">'data_class'</span> <span class="o">=&gt;</span> <span class="nx">Question</span><span class="o">::</span><span class="na">class</span><span class="p">,</span>
            <span class="s1">'empty_data'</span> <span class="o">=&gt;</span> <span class="k">function</span> <span class="p">(</span><span class="nx">Options</span> <span class="nv">$options</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="k">function</span> <span class="p">(</span><span class="nx">FormInterface</span> <span class="nv">$form</span><span class="p">)</span> <span class="k">use</span> <span class="p">(</span><span class="nv">$options</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="k">new</span> <span class="nx">Question</span><span class="p">(</span>
                        <span class="nv">$form</span><span class="p">[</span><span class="s1">'title'</span><span class="p">]</span><span class="o">-&gt;</span><span class="na">getData</span><span class="p">(),</span>
                        <span class="nv">$form</span><span class="p">[</span><span class="s1">'description'</span><span class="p">]</span><span class="o">-&gt;</span><span class="na">getData</span><span class="p">(),</span>
                        <span class="nv">$options</span><span class="p">[</span><span class="s1">'author'</span><span class="p">]</span>
                    <span class="p">);</span>
                <span class="p">};</span>
            <span class="p">},</span>
        <span class="p">]);</span>

        <span class="nv">$resolver</span><span class="o">-&gt;</span><span class="na">setRequired</span><span class="p">(</span><span class="s1">'author'</span><span class="p">);</span>
        <span class="nv">$resolver</span><span class="o">-&gt;</span><span class="na">setAllowedTypes</span><span class="p">(</span><span class="s1">'author'</span><span class="p">,</span> <span class="s1">'string'</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table>
</div>

<p>Nuestro formulario posee dos campos <strong>title</strong> y <em>*description</em>, además requiere de una opción <code class="highlighter-rouge">author</code> que será el nombre del usuario que hace la pregunta.</p>

<p>Hemos definido la opción <code class="highlighter-rouge">empty_data</code> debido a que la clase <code class="highlighter-rouge">Forum\Question\Question</code> requiere que le pasemos algunos datos en su constructor, y la forma de hacerlo es con <a href="http://symfony.com/doc/current/form/use_empty_data.html#option-1-instantiate-a-new-class">dicha opción</a>.</p>

<h5 id="el-srcappcontrollerquestioncontrollerphp">El <strong>src/App/Controller/QuestionController.php</strong></h5>

<div class="language-php highlighter-rouge"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45</pre></td><td class="code"><pre><span class="cp">&lt;?php</span> <span class="c1">// src/App/Controller/QuestionController.php
</span>
<span class="k">namespace</span> <span class="nx">App\Controller</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">App\Form\QuestionType</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Forum\Question\Question</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Sensio\Bundle\FrameworkExtraBundle\Configuration\Route</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Bundle\FrameworkBundle\Controller\Controller</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\HttpFoundation\Request</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">QuestionController</span> <span class="k">extends</span> <span class="nx">Controller</span>
<span class="p">{</span>
    <span class="sd">/**
     * @Route("/", name="question_list")
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">listAction</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$questions</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">'repository.question'</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">findAll</span><span class="p">();</span>

        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">render</span><span class="p">(</span><span class="s1">'question/list.html.twig'</span><span class="p">,</span> <span class="p">[</span>
            <span class="s1">'questions'</span> <span class="o">=&gt;</span> <span class="nv">$questions</span><span class="p">,</span>
        <span class="p">]);</span>
    <span class="p">}</span>

    <span class="sd">/**
     * @Route("/new", name="question_create")
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">newAction</span><span class="p">(</span><span class="nx">Request</span> <span class="nv">$request</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$form</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">createForm</span><span class="p">(</span><span class="nx">QuestionType</span><span class="o">::</span><span class="na">class</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="p">[</span>
            <span class="s1">'author'</span> <span class="o">=&gt;</span> <span class="s1">'test@test.com'</span><span class="p">,</span>
        <span class="p">]);</span>
        <span class="nv">$form</span><span class="o">-&gt;</span><span class="na">handleRequest</span><span class="p">(</span><span class="nv">$request</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="nv">$form</span><span class="o">-&gt;</span><span class="na">isSubmitted</span><span class="p">()</span> <span class="k">and</span> <span class="nv">$form</span><span class="o">-&gt;</span><span class="na">isValid</span><span class="p">())</span> <span class="p">{</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">'repository.question'</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">save</span><span class="p">(</span><span class="nv">$form</span><span class="o">-&gt;</span><span class="na">getData</span><span class="p">());</span>

            <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">redirectToRoute</span><span class="p">(</span><span class="s1">'question_list'</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">render</span><span class="p">(</span><span class="s1">'question/new.html.twig'</span><span class="p">,</span> <span class="p">[</span>
            <span class="s1">'form'</span> <span class="o">=&gt;</span> <span class="nv">$form</span><span class="o">-&gt;</span><span class="na">createView</span><span class="p">(),</span>
        <span class="p">]);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table>
</div>

<p>El controlador posee dos acciones <code class="highlighter-rouge">"/"</code> y <code class="highlighter-rouge">"/new"</code>, la primera se encarga de listar las preguntas y la segunda nos permite crearlas.</p>

<h5 id="las-vistas">Las vistas</h5>

<p>Cada acción va a cargar una vista, y el contenido de cada una es el siguiente:</p>

<p><strong>app/Resources/views/question/list.html.twig</strong></p>

<div class="language-twig highlighter-rouge"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23</pre></td><td class="code"><pre><span class="cp">{%</span> <span class="k">extends</span> <span class="s1">'base.html.twig'</span> <span class="cp">%}</span>

<span class="cp">{%</span> <span class="k">block</span> <span class="nv">page_header</span> <span class="cp">%}</span>
    Preguntas Recientes
    <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"pull-right"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"</span><span class="cp">{{</span> <span class="nv">path</span><span class="p">(</span><span class="s1">'question_create'</span><span class="p">)</span> <span class="cp">}}</span><span class="s">"</span> <span class="na">class=</span><span class="s">"button primary"</span><span class="nt">&gt;</span>Hacer una Pregunta<span class="nt">&lt;/a&gt;</span>
    <span class="nt">&lt;/span&gt;</span>
<span class="cp">{%</span> <span class="k">endblock</span> <span class="cp">%}</span>

<span class="cp">{%</span> <span class="k">block</span> <span class="nv">content</span> <span class="cp">%}</span>
    <span class="cp">{%</span> <span class="k">for</span> <span class="nv">question</span> <span class="ow">in</span> <span class="nv">questions</span> <span class="cp">%}</span>
        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"question"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;h3&gt;&lt;a</span> <span class="na">href=</span><span class="s">"</span><span class="cp">{{</span> <span class="nv">path</span><span class="p">(</span><span class="s1">'question_list'</span><span class="p">)</span> <span class="cp">}}</span><span class="s">"</span><span class="nt">&gt;</span><span class="cp">{{</span> <span class="nv">question.title</span> <span class="cp">}}</span><span class="nt">&lt;/a&gt;&lt;/h3&gt;</span>
            <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"question-content"</span><span class="nt">&gt;</span><span class="cp">{{</span> <span class="nv">question.description</span> <span class="cp">}}</span><span class="nt">&lt;/div&gt;</span>
            <span class="nt">&lt;p</span> <span class="na">class=</span><span class="s">"question-footer"</span><span class="nt">&gt;</span>
                <span class="cp">{{</span> <span class="nv">question.author</span> <span class="cp">}}</span> - <span class="cp">{{</span> <span class="nv">question.createdAt</span><span class="o">|</span><span class="nf">date</span> <span class="cp">}}</span>
            <span class="nt">&lt;/p&gt;</span>
        <span class="nt">&lt;/div&gt;</span>
    <span class="cp">{%</span> <span class="k">else</span> <span class="cp">%}</span>
        <span class="nt">&lt;h2&gt;</span>No hay preguntas creadas<span class="nt">&lt;/h2&gt;</span>
    <span class="cp">{%</span> <span class="k">endfor</span> <span class="cp">%}</span>
<span class="cp">{%</span> <span class="k">endblock</span> <span class="cp">%}</span>

</pre></td></tr></tbody></table>
</div>

<p><strong>app/Resources/views/question/new.html.twig</strong></p>

<div class="language-twig highlighter-rouge"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16</pre></td><td class="code"><pre><span class="cp">{%</span> <span class="k">extends</span> <span class="s1">'base.html.twig'</span> <span class="cp">%}</span>

<span class="cp">{%</span> <span class="k">block</span> <span class="nv">page_header</span> <span class="cp">%}</span>
    Crear Pregunta
<span class="cp">{%</span> <span class="k">endblock</span> <span class="cp">%}</span>

<span class="cp">{%</span> <span class="k">block</span> <span class="nv">content</span> <span class="cp">%}</span>
    <span class="cp">{{</span> <span class="nv">form_start</span><span class="p">(</span><span class="nv">form</span><span class="p">,</span> <span class="err">{</span><span class="nv">attr</span><span class="err">:</span> <span class="err">{</span><span class="nv">novalidate</span><span class="err">:</span> <span class="s1">'novalidate'</span><span class="cp">}}</span>) }}
    <span class="cp">{{</span> <span class="nv">form_row</span><span class="p">(</span><span class="nv">form.title</span><span class="p">,</span> <span class="err">{</span> <span class="nv">label</span><span class="err">:</span> <span class="s1">'Título de la Pregunta'</span> <span class="err">}</span><span class="p">)</span> <span class="cp">}}</span>
    <span class="cp">{{</span> <span class="nv">form_row</span><span class="p">(</span><span class="nv">form.description</span><span class="p">,</span> <span class="err">{</span> <span class="nv">label</span><span class="err">:</span> <span class="s1">'Descripción de la Pregunta'</span><span class="p">,</span> <span class="nv">attr</span><span class="err">:</span> <span class="err">{</span> <span class="nv">class</span><span class="err">:</span><span class="s1">'description-widget'</span> <span class="err">}</span> <span class="err">}</span><span class="p">)</span> <span class="cp">}}</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"form-actions"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"submit"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"</span><span class="cp">{{</span> <span class="nv">path</span><span class="p">(</span><span class="s1">'question_list'</span><span class="p">)</span> <span class="cp">}}</span><span class="s">"</span> <span class="na">class=</span><span class="s">"button"</span><span class="nt">&gt;</span>Volver<span class="nt">&lt;/a&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
    <span class="cp">{{</span> <span class="nv">form_end</span><span class="p">(</span><span class="nv">form</span><span class="p">)</span> <span class="cp">}}</span>
<span class="cp">{%</span> <span class="k">endblock</span> <span class="cp">%}</span>
</pre></td></tr></tbody></table>
</div>

<p>Eso es todo, sí ahora iniciamos el servidor con <code class="highlighter-rouge">php -S localhost:8000 -t web</code>, veremos una pantalla como la siguiente:</p>

<h5 id="pantallas-de-la-aplicacin">Pantallas de la aplicación</h5>

<p><img src="/assets/images/micro-foro/2-listado-vacio.png" alt="Listado de Preguntas" /></p>

<p>Esta pantalla muestra el listado de Preguntas, que ahora mismo está vacio. Si presionamos el botón <img src="/assets/images/micro-foro/2-boton-hacer-pregunta.png" class="img-inline" alt="Hacer una Pregunta" style="max-width: 130px;" /> Vamos a ver un formulario como el siguiente:</p>

<p><img src="/assets/images/micro-foro/2-form-valido.png" alt="Formulario de pregunta" /></p>

<p>Nuestro formulario posee dos campos, uno para el título y otro para la descripción de la pregunta. Ingresando una data de prueba y Presionando el botón de <img src="/assets/images/micro-foro/2-boton-form.png" class="img-inline" alt="Hacer una Pregunta" style="max-width: 100px;" /> La aplicación creará la pregunta y nos va a redirigir al listado de preguntas, donde podremos visualizar el registro recien creado:</p>

<!--
![Listado de Preguntas](/assets/images/micro-foro/2-form.png)
![Listado de Preguntas](/assets/images/micro-foro/2-form-invalido.png)
-->

<p><img src="/assets/images/micro-foro/2-listado.png" alt="Listado de Preguntas" /></p>

<p>Como se puede apreciar, ahora en el listado aparece la pregunta recien creada.</p>

<p>Bueno, hasta acá la segunda parte de la construcción del micro foro. Más adelante seguiremos con la administración de las preguntas, añadiendo seguridad al sitio web para relacionar las preguntas que se crean con el usuario logueado.</p>

        </section>

        

        <footer class="post-footer">
            
            <section class="author">
                <header> <a href="http://manuelj555.github.io/"> <img class="profile" src="/assets/images/profile.png" alt="Author's profile picture"></a></header>
                <article>
                    <h4> Manuel Aguirre <programador.manuel@gmail.com> </h4>
                    <p> 
                        Desarrollador Web, (PHP, HTML, css, javascript).<br/>
                        Intento usar Symfony2 y/o sus componentes en mis proyectos.<br/>
                        Apasionado por el aprendizaje y loco por la Programación :-)
                    </p>
                </article>
            </section>                
            

            <section class="share">
                <h4>Comparte</h4>
                <a class="icon-twitter" href="http://twitter.com/share?text=Creando un Foro con el MicroKernelTrait de Symfony (Parte 2)&amp;url=/2016/08/21/foro-micro-kernel-trait-symfony-parte-2.html"
                   onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');
                           return false;">
                    <span class="hidden">Twitter</span>
                </a>
                <a class="icon-facebook" href="https://www.facebook.com/sharer/sharer.php?u=/2016/08/21/foro-micro-kernel-trait-symfony-parte-2.html"
                   onclick="window.open(this.href, 'facebook-share', 'width=580,height=296');
                           return false;">
                    <span class="hidden">Facebook</span>
                </a>
                <a class="icon-google-plus" href="https://plus.google.com/share?url=/2016/08/21/foro-micro-kernel-trait-symfony-parte-2.html"
                   onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');
                           return false;">
                    <span class="hidden">Google+</span>
                </a>
            </section>

            
            <section class="disqus">
                <div id="disqus_thread"></div>
                <script type="text/javascript">
                    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
                    var disqus_shortname = 'phpsymfonytipsmanuelj555'; // required: replace example with your forum shortname

                    /* * * DON'T EDIT BELOW THIS LINE * * */
                    (function() {
                        var dsq = document.createElement('script');
                        dsq.type = 'text/javascript';
                        dsq.async = true;
                        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                    })();
                </script>
                <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
                <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
            </section>
            

        </footer>

    </article>

</main>


    <script type="text/javascript" src="/assets/js/jquery-1.10.2.min.js"></script>
    <script type="text/javascript" src="/assets/js/jquery.fitvids.js"></script>
    <script type="text/javascript" src="/assets/js/index.js"></script>

    <!-- Google Analytics Tracking code -->
    <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-59688229-1', 'auto');
        ga('send', 'pageview');

    </script>
</body>
</html>
